<!DOCTYPE html>
<html lang='ko'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>ë‚˜ë§Œì˜ ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤</title>
    
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src='https://cdn.tailwindcss.com'></script>
    <style>
        /* í°íŠ¸ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; }
        
        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼: ë¶€ëª¨ ì»¨í…Œì´ë„ˆì— ë§ê²Œ ë°˜ì‘í˜•ìœ¼ë¡œ ì¡°ì • */
        #drawingCanvas {
            background-color: #ffffff;
            touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
            cursor: crosshair;
        }

        /* í…œí”Œë¦¿ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼ */
        .template-thumbnail {
            width: 35px; /* í¬ê¸° 80%ë¡œ ì¡°ì • */
            height: 35px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.1s;
            flex-shrink: 0; 
        }

        .template-thumbnail:hover {
            transform: scale(1.05);
        }

        .template-thumbnail.active {
            box-shadow: 0 0 0 3px #4F46E5; /* ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ë¡œ í™œì„±í™” í‘œì‹œ */
        }
        
        /* ìƒ‰ìƒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #colorPalette button {
            width: 16px; /* í¬ê¸° 80%ë¡œ ì¡°ì • */
            height: 16px;
            margin: 2px;
        }

        /* í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        #textInput {
            position: absolute; /* ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ì ˆëŒ€ ìœ„ì¹˜ */
            padding: 4px;
            min-width: 100px; /* ìµœì†Œ ë„ˆë¹„ ì„¤ì • */
            border: 1px solid #4F46E5; /* ë³´ë¼ìƒ‰ í…Œë‘ë¦¬ë¡œ ê°•ì¡° */
            outline: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-family: 'Inter', sans-serif;
            background-color: rgba(255, 255, 255, 0.9); /* ë°˜íˆ¬ëª… ë°°ê²½ */
        }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° */
        #colorPalette::-webkit-scrollbar,
        #templateSelector::-webkit-scrollbar,
        #promptInput::-webkit-scrollbar {
            display: none;
        }
        #colorPalette, #templateSelector, #promptInput {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<!-- ë³€ê²½: h-screen, items-center, overflow-hiddenì„ ì¶”ê°€í•˜ì—¬ í™”ë©´ í¬ê¸°ì— ë§ì¶¥ë‹ˆë‹¤. -->
<body class='bg-gray-50 h-screen p-2 flex items-center justify-center overflow-hidden'>
    <!-- ë³€ê²½: max-w-4xl -> max-w-3xl, max-h-[96%] ë° h-[96%]ë¥¼ ì¶”ê°€í•˜ì—¬ ë†’ì´ë¥¼ ê°•ì œí•©ë‹ˆë‹¤. -->
    <div id='appContainer' class='w-full max-w-3xl max-h-[96%] h-[96%] bg-white shadow-2xl rounded-xl flex flex-col lg:flex-row overflow-hidden'>
        
        <!-- 1. ì¢Œì¸¡ ë„êµ¬ ë° í…œí”Œë¦¿ íŒ¨ë„ (ì‘ì€ í¬ê¸°: lg:w-32) -->
        <!-- ë†’ì´ ì œì•½ì„ ìœ„í•´ overflow-y-auto ì¶”ê°€ -->
        <div class='lg:w-32 p-2 bg-gray-100 border-r border-gray-200 flex flex-col space-y-3 overflow-y-auto'>
            
            <h2 class='text-base font-bold text-gray-800 border-b border-gray-300 pb-1'>ë„êµ¬ ë©”ë‰´</h2>

            <!-- 1.1. ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ìƒ‰ìƒ ì¶”ê°€) -->
            <div class='space-y-1'>
                <h3 class='text-xs font-medium text-gray-700'>ìƒ‰ìƒ ì„ íƒ (ì´ 14ê°œ)</h3>
                <div id='colorPalette' class='flex flex-wrap items-center'>
                    <!-- í™•ì¥ëœ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ -->
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-black' style='background-color: #000000;' data-color='#000000' title='ê²€ì •'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-white' style='background-color: #FFFFFF; border: 1px solid #ddd;' data-color='#FFFFFF' title='í°ìƒ‰'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-red-500' style='background-color: #FF0000;' data-color='#FF0000' title='ë¹¨ê°•'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-blue-500' style='background-color: #0000FF;' data-color='#0000FF' title='íŒŒë‘'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-green-500' style='background-color: #008000;' data-color='#008000' title='ì´ˆë¡'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-yellow-500' style='background-color: #FFFF00;' data-color='#FFFF00' title='ë…¸ë‘'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-purple-500' style='background-color: #800080;' data-color='#800080' title='ë³´ë¼'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-gray-500' style='background-color: #808080;' data-color='#808080' title='íšŒìƒ‰'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-pink-500' style='background-color: #FFC0CB;' data-color='#FFC0CB' title='ë¶„í™'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-orange-500' style='background-color: #FFA500;' data-color='#FFA500' title='ì£¼í™©'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-cyan-500' style='background-color: #00FFFF;' data-color='#00FFFF' title='ì‹œì•ˆ'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-yellow-700' style='background-color: #A52A2A;' data-color='#A52A2A' title='ê°ˆìƒ‰'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-yellow-400' style='background-color: #FFD700;' data-color='#FFD700' title='ê¸ˆìƒ‰'></button>
                    <button class='w-4 h-4 rounded-full shadow-md transition hover:ring-4 ring-offset-2 ring-opacity-75 m-0.5 ring-emerald-500' style='background-color: #008080;' data-color='#008080' title='ì²­ë¡'></button>
                </div>
            </div>
            
            <!-- 1.2. êµµê¸° ì¡°ì ˆ -->
            <div class='mt-1'>
                <label for='lineWidth' class='block text-xs font-medium text-gray-700 mb-0.5'>êµµê¸°: <span id='lineWidthValue' class='font-bold text-indigo-600'>5</span>px</label>
                <input type='range' id='lineWidth' min='1' max='50' value='5' class='w-full h-1.5 bg-indigo-200 rounded-lg appearance-none cursor-pointer range-lg'>
            </div>

            <!-- 1.3. ë„êµ¬ ì„ íƒ -->
            <div class='space-y-1 pt-1 border-t border-gray-300'>
                <h3 class='text-xs font-medium text-gray-700'>ë„êµ¬ ì¢…ë¥˜</h3>
                <div class='flex flex-col space-y-1'>
                    <button id='toolBrush' class='tool-button bg-indigo-600 shadow-xl text-white px-2 py-1 rounded-md transition' data-tool='brush'>
                        <span class='font-semibold text-xs'>ë¶“</span>
                    </button>
                    <button id='toolEraser' class='tool-button bg-white text-gray-700 border border-gray-300 px-2 py-1 rounded-md shadow-md hover:bg-gray-200 transition' data-tool='eraser'>
                        <span class='font-semibold text-xs'>ì§€ìš°ê°œ</span>
                    </button>
                    <button id='toolText' class='tool-button bg-white text-gray-700 border border-gray-300 px-2 py-1 rounded-md shadow-md hover:bg-gray-200 transition' data-tool='text'>
                        <span class='font-semibold text-xs'>í…ìŠ¤íŠ¸</span>
                    </button>
                </div>
            </div>

            <!-- 1.4. ë°‘ê·¸ë¦¼ ì„ íƒ (10ê°œ í…œí”Œë¦¿ í¬í•¨) -->
            <div class='pt-2 border-t border-gray-300 flex flex-col space-y-1'>
                <h3 class='text-xs font-semibold text-gray-800'>ë°‘ê·¸ë¦¼</h3>
                <div id='templateSelector' class='flex flex-wrap gap-1'>
                    <!-- 10ê°œì˜ í…œí”Œë¦¿ ì¸ë„¤ì¼ì´ JavaScriptì— ì˜í•´ ë™ì ìœ¼ë¡œ ì—¬ê¸°ì— ì‚½ì…ë©ë‹ˆë‹¤. -->
                </div>
            </div>
            
            <!-- 1.5. í”„ë¡¬í”„íŠ¸ ì…ë ¥ê¸° -->
            <div class='pt-3 border-t border-gray-300 flex flex-col space-y-2'>
                <h3 class='text-xs font-semibold text-gray-800 flex items-center'>
                    <span class='mr-1'>ğŸ“</span> í”„ë¡¬í”„íŠ¸ ì…ë ¥
                </h3>

                <!-- ìº”ë²„ìŠ¤ ê·¸ë¦¼ì´ ì°¸ê³  ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ë¨ì„ ëª…ì‹œ -->
                <div class='w-full text-center bg-gray-200 text-gray-600 px-2 py-1 rounded-md text-xs font-medium border border-gray-300'>
                    ê·¸ë¦¼ ì €ì¥ ì‹œ ì•„ë˜ í…ìŠ¤íŠ¸ê°€ í•¨ê»˜ ì €ì¥ë©ë‹ˆë‹¤.
                </div>
                
                <!-- í”„ë¡¬í”„íŠ¸ ì…ë ¥ ì˜ì—­ -->
                <textarea id='promptInput' rows='4' class='w-full text-xs p-1.5 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 resize-none placeholder-gray-400' placeholder='[í•„ìˆ˜] ì£¼ì œ, ìŠ¤íƒ€ì¼, íŠ¹ì§•ì„ êµ¬ì²´ì ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.&#10;&#10;ì˜ˆì‹œ)&#10;ì£¼ì œ: ìš°ì£¼ë³µì„ ì…ì€ ê·€ì—¬ìš´ ë¶ˆë…&#10;ìŠ¤íƒ€ì¼: ë ˆíŠ¸ë¡œ íŒì•„íŠ¸'></textarea>
                
                <!-- í”„ë¡¬í”„íŠ¸ ë“±ë¡ ë²„íŠ¼ (AI í˜¸ì¶œ ê¸°ëŠ¥ ì œê±°) -->
                <button id='registerPrompt' class='bg-indigo-500 text-white px-2 py-1 rounded-md shadow-md hover:bg-indigo-600 transition text-xs font-bold disabled:bg-indigo-300' disabled>
                    í”„ë¡¬í”„íŠ¸ ë“±ë¡
                </button>
            </div>
        </div>

        <!-- 2. ìš°ì¸¡ ìº”ë²„ìŠ¤ ì˜ì—­ (ìµœëŒ€ í¬ê¸°: flex-1) -->
        <div class='flex-1 p-2 flex flex-col space-y-1'>
            
            <!-- íƒ€ì´í‹€ ë° ì„¤ëª… -->
            <h1 class='text-lg font-bold text-gray-900 leading-tight'>ë‚˜ë§Œì˜ ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤</h1>
            <p id='descriptionText' class='text-xs text-gray-500 leading-snug'>ë°‘ê·¸ë¦¼ì„ ì„ íƒí•˜ê³ , ìƒ‰ê³¼ êµµê¸°ë¥¼ ì •í•œ í›„ ììœ ë¡­ê²Œ ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”! (í…ìŠ¤íŠ¸ ë„êµ¬ ì„ íƒ í›„ ìº”ë²„ìŠ¤ í´ë¦­)</p>
            
            <!-- ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ ê²°ê³¼ ì˜ì—­ (ìº”ë²„ìŠ¤ ìƒë‹¨) -->
            <div id="promptOutput" class='p-3 bg-gray-100 rounded-lg border border-indigo-300 hidden'>
                <h3 class='text-sm font-bold text-indigo-700 mb-2 flex items-center'>
                    <span class='mr-1'>ğŸ“</span> ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ (ê·¸ë¦¼ ì €ì¥ ì‹œ í¬í•¨ë¨):
                </h3>
                <p id='promptTextDisplay' class='text-xs text-gray-800 leading-relaxed font-mono whitespace-pre-wrap p-2 bg-white border border-gray-200 rounded-md'></p>
                <button id='copyPromptButton' class='mt-2 bg-indigo-500 text-white px-3 py-1 rounded-md shadow-md hover:bg-indigo-600 transition text-xs font-semibold'>
                    í”„ë¡¬í”„íŠ¸ ë³µì‚¬
                </button>
            </div>

            <!-- ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ (flex-1ë¡œ ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€) -->
            <!-- min-h-[300px]ì„ min-h-[250px]ë¡œ ì¤„ì—¬ì„œ ë†’ì´ í™•ë³´ -->
            <div id='canvasContainer' class='bg-gray-200 flex-1 flex items-center justify-center rounded-lg shadow-inner overflow-hidden relative min-h-[250px]'>
                <!-- 1. ë“œë¡œì‰ ìº”ë²„ìŠ¤ -->
                <canvas id='drawingCanvas' class='w-full h-full'></canvas>
                <!-- í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ: í…ìŠ¤íŠ¸ ë„êµ¬ ì‚¬ìš© ì‹œ ì—¬ê¸°ì— ë‚˜íƒ€ë‚¨ (ìˆ˜ì •ëœ ìœ„ì¹˜ ë° ìŠ¤íƒ€ì¼) -->
                <input type="text" id="textInput" class="hidden" placeholder="í…ìŠ¤íŠ¸ ì…ë ¥">
            </div>

            <!-- ì•¡ì…˜ ë²„íŠ¼ (ë“œë¡œì‰ ì»¨íŠ¸ë¡¤) -->
            <div id="actionButtons" class='flex justify-center space-x-2 pt-1 pb-1'>
                <button id='undoButton' class='bg-yellow-500 text-white px-3 py-1.5 rounded-full shadow-lg hover:bg-yellow-600 transition font-bold text-xs disabled:bg-gray-400' disabled>
                    <svg class='w-3.5 h-3.5 inline-block mr-0.5' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M11 15.5l-3-3m0 0l3-3m-3 3h8m-8 3H5a2 2 0 01-2-2V7a2 2 0 012-2h10a2 2 0 012 2v1'/></svg>
                    ë˜ëŒë¦¬ê¸°
                </button>
                <button id='clearButton' class='bg-red-500 text-white px-3 py-1.5 rounded-full shadow-lg hover:bg-red-600 transition font-bold text-xs'>
                    <svg class='w-3.5 h-3.5 inline-block mr-0.5' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16'></path></svg>
                    ì´ˆê¸°í™”
                </button>
                <button id='saveButton' class='bg-green-500 text-white px-3 py-1.5 rounded-full shadow-lg hover:bg-green-600 transition font-bold text-xs'>
                    <svg class='w-3.5 h-3.5 inline-block mr-0.5' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'><path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4'></path></svg>
                    ê·¸ë¦¼ ì €ì¥
                </button>
            </div>
            
        </div>
    </div>

    
    <!-- ëª¨ë‹¬ ì°½ (ì•Œë¦¼ ë©”ì‹œì§€ìš©) -->
    <div id='messageModal' class='hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300'>
        <div class='bg-white p-6 rounded-xl shadow-2xl text-center max-w-sm w-11/12'>
            <p id='modalMessage' class='text-xl font-semibold text-gray-800 mb-4'></p>
            <button id='modalCloseButton' class='bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 font-medium transition'>í™•ì¸</button>
        </div>
    </div>

    <script type="module">
        // --- Canvas Drawing Logic ---

        const canvas = document.getElementById('drawingCanvas');
        const container = document.getElementById('canvasContainer');
        const ctx = canvas.getContext('2d');
        const lineWidthInput = document.getElementById('lineWidth');
        const lineWidthValue = document.getElementById('lineWidthValue');
        const colorPalette = document.getElementById('colorPalette');
        const toolButtons = document.querySelectorAll('.tool-button');
        const clearButton = document.getElementById('clearButton');
        const saveButton = document.getElementById('saveButton');
        const textInput = document.getElementById('textInput');
        const templateSelector = document.getElementById('templateSelector');
        
        // Prompt Elements
        const registerPromptButton = document.getElementById('registerPrompt');
        const promptInput = document.getElementById('promptInput');

        // Prompt Output Elements
        const promptOutput = document.getElementById('promptOutput');
        const promptTextDisplay = document.getElementById('promptTextDisplay');
        const copyPromptButton = document.getElementById('copyPromptButton');
        let currentInputPrompt = ''; // ë“±ë¡ëœ ì‚¬ìš©ì ì…ë ¥ í”„ë¡¬í”„íŠ¸ë¥¼ ì €ì¥í•  ë³€ìˆ˜

        // History Elements
        const undoButton = document.getElementById('undoButton');
        const MAX_HISTORY_SIZE = 20;
        let historyStack = []; // ìº”ë²„ìŠ¤ ìƒíƒœ ì €ì¥ ìŠ¤íƒ

        // UI Control Elements
        const descriptionText = document.getElementById('descriptionText');

        // Modal Elements
        const messageModal = document.getElementById('messageModal');
        const modalMessage = document.getElementById('modalMessage');
        const modalCloseButton = document.getElementById('modalCloseButton');
        
        let isDrawing = false;
        let hasDrawn = false; // ì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ìº”ë²„ìŠ¤ì— ê·¸ë ¸ëŠ”ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        let lastX = 0;
        let lastY = 0;
        let color = '#000000';
        let lineWidth = 5;
        let currentTool = 'brush';
        
        // Templates (URL, Title, index) - 10ê°œ í…œí”Œë¦¿
        const templates = [
            { url: 'https://i.postimg.cc/kg20RfFr/1.png', title: 'ë°‘ê·¸ë¦¼ 1: ê³ ì–‘ì´' },
            { url: 'https://i.postimg.cc/T3BZVgCY/2.png', title: 'ë°‘ê·¸ë¦¼ 2: ì¸ë¬¼í™”' },
            { url: 'https://i.postimg.cc/Jn3V40Ng/3.png', title: 'ë°‘ê·¸ë¦¼ 3: í’ê²½' },
            { url: 'https://i.postimg.cc/rmGXFsGm/4.png', title: 'ë°‘ê·¸ë¦¼ 4: ê½ƒ' },
            { url: 'https://i.postimg.cc/nzKbcrKf/5.png', title: 'ë°‘ê·¸ë¦¼ 5: ìë™ì°¨' },
            { url: 'https://i.postimg.cc/ZRzzSpdM/6.png', title: 'ë°‘ê·¸ë¦¼ 6: ê±´ë¬¼' },
            { url: 'https://i.postimg.cc/6q9s7KzL/7.png', title: 'ë°‘ê·¸ë¦¼ 7: ìƒˆ' },
            { url: 'https://i.postimg.cc/j2vpP1FY/8.png', title: 'ë°‘ê·¸ë¦¼ 8: ë‚˜ë¹„' },
            { url: 'https://i.postimg.cc/cLPVRwT2/9.png', title: 'ë°‘ê·¸ë¦¼ 9: ì»µ' },
            { url: 'https://i.postimg.cc/CxR3nmHT/10.png', title: 'ë°‘ê·¸ë¦¼ 10: ê³¼ì¼' },
        ];
        let activeTemplateIndex = 0;

        // --- Utility Functions ---

        /**
         * Custom alert/message box function.
         */
        function showMessage(message) {
            modalMessage.textContent = message;
            modalCloseButton.addEventListener('click', hideMessage);
            messageModal.classList.remove('hidden');
            messageModal.classList.add('opacity-100');
        }

        /**
         * Hides the custom alert/message box.
         */
        function hideMessage() {
            modalMessage.textContent = ''; // Clear content on hide
            messageModal.classList.add('hidden');
            messageModal.classList.remove('opacity-100');
        }

        /**
         * í”„ë¡¬í”„íŠ¸ ë“±ë¡ ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updatePromptButtonState() {
            const promptValid = promptInput.value.trim().length > 0;
            // ìº”ë²„ìŠ¤ì— ë­”ê°€ ê·¸ë ¤ì ¸ ìˆê±°ë‚˜(hasDrawn) í”„ë¡¬í”„íŠ¸ê°€ ì…ë ¥ë˜ë©´ ë“±ë¡ ê°€ëŠ¥
            const canRegister = hasDrawn || promptValid; 
            registerPromptButton.disabled = !canRegister;
        }

        /**
         * ë˜ëŒë¦¬ê¸° ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * ìŠ¤íƒì— 1ê°œ(í˜„ì¬ ìƒíƒœ)ë§Œ ìˆë‹¤ë©´ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.
         */
        function updateUndoButtonState() {
            undoButton.disabled = historyStack.length <= 1;
        }

        /**
         * í˜„ì¬ ìº”ë²„ìŠ¤ ìƒíƒœë¥¼ historyStackì— ì €ì¥í•©ë‹ˆë‹¤.
         */
        function saveState() {
            if (historyStack.length >= MAX_HISTORY_SIZE) {
                historyStack.shift(); // ê°€ì¥ ì˜¤ë˜ëœ ìƒíƒœ ì œê±°
            }
            historyStack.push(canvas.toDataURL('image/png'));
            updateUndoButtonState();
        }

        /**
         * Fallback for copying text to clipboard in iframe environments.
         */
        function fallbackCopyTextToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed'; // Keep it off-screen
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessage('ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (err) {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                showMessage('í´ë¦½ë³´ë“œ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            document.body.removeChild(textarea);
        }

        /**
         * Sets up canvas size to fit container and scales context for high resolution drawing.
         * Reloads the active template.
         */
        const RESOLUTION_SCALE = 1.0; 
        function resizeCanvas() {
            const displayWidth = container.clientWidth;
            const displayHeight = container.clientHeight;

            // Set canvas drawing buffer size (actual pixels)
            canvas.width = displayWidth * RESOLUTION_SCALE;
            canvas.height = displayHeight * RESOLUTION_SCALE;
            
            // Scale the context so drawing commands use CSS pixels (for easier coordinate mapping)
            ctx.scale(RESOLUTION_SCALE, RESOLUTION_SCALE);

            // Redraw everything if necessary, or just clear and load template
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, displayWidth, displayHeight); 
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ë³€ê²½ ì‹œ íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ë° í…œí”Œë¦¿ ì¬ë¡œë“œ
            historyStack = [];
            loadTemplate(activeTemplateIndex, true); // true: resizeë¡œ ì¸í•œ ë¡œë“œ

            // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ë³€ê²½ë˜ë©´ 'ê·¸ë¦¼ì„ ê·¸ë¦¬ì§€ ì•Šì€ ìƒíƒœ'ë¡œ ì´ˆê¸°í™”
            hasDrawn = false;
            updatePromptButtonState();
            promptOutput.classList.add('hidden');
            descriptionText.textContent = 'ë°‘ê·¸ë¦¼ì„ ì„ íƒí•˜ê³ , ìƒ‰ê³¼ êµµê¸°ë¥¼ ì •í•œ í›„ ììœ ë¡­ê²Œ ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”! (í…ìŠ¤íŠ¸ ë„êµ¬ ì„ íƒ í›„ ìº”ë²„ìŠ¤ í´ë¦­)';
        }

        /**
         * Loads the selected template image onto the canvas.
         */
        function loadTemplate(index, isSilent = false) {
            activeTemplateIndex = index;
            const template = templates[index];
            if (!template) return;

            // Update active thumbnail state
            document.querySelectorAll('.template-thumbnail').forEach(thumb => {
                thumb.classList.remove('active', 'border-indigo-600');
                thumb.classList.add('border-gray-300');
            });
            const activeThumb = document.querySelector(`.template-thumbnail[data-index='${index}']`);
            if (activeThumb) {
                activeThumb.classList.add('active', 'border-indigo-600');
                activeThumb.classList.remove('border-gray-300');
            }
            
            const img = new Image();
            img.crossOrigin = 'Anonymous'; 
            
            img.onload = function() {
                const canvasDisplayWidth = canvas.width / RESOLUTION_SCALE;
                const canvasDisplayHeight = canvas.height / RESOLUTION_SCALE;
                
                // Clear canvas before drawing new template
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvasDisplayWidth, canvasDisplayHeight);
                
                // Calculate draw dimensions to fit within canvas while maintaining aspect ratio
                const imageRatio = img.width / img.height;
                let drawWidth, drawHeight, offsetX, offsetY;
                
                const canvasRatio = canvasDisplayWidth / canvasDisplayHeight;
                
                if (imageRatio > canvasRatio) {
                    drawWidth = canvasDisplayWidth;
                    drawHeight = canvasDisplayWidth / imageRatio;
                    offsetX = 0;
                    offsetY = (canvasDisplayHeight - drawHeight) / 2;
                } else {
                    drawHeight = canvasDisplayHeight;
                    drawWidth = canvasDisplayHeight * imageRatio;
                    offsetX = (canvasDisplayWidth - drawWidth) / 2;
                    offsetY = 0;
                }
                
                ctx.globalAlpha = 0.5; // íˆ¬ëª…ë„ ì„¤ì •
                ctx.drawImage(img, offsetX, offsetY, drawWidth, drawHeight);
                ctx.globalAlpha = 1.0; // íˆ¬ëª…ë„ ì´ˆê¸°í™”
                
                // í…œí”Œë¦¿ ë¡œë“œ í›„ ìƒíƒœ ì €ì¥
                saveState();

                // í…œí”Œë¦¿ ë¡œë“œ í›„ì—ëŠ” 'ê·¸ë¦¼ì„ ê·¸ë¦¬ì§€ ì•Šì€ ìƒíƒœ'ë¡œ ì´ˆê¸°í™” (resizeë‚˜ clearê°€ ì•„ë‹Œ í…œí”Œë¦¿ ì„ íƒ ì‹œì—ë§Œ)
                if (!isSilent) {
                    hasDrawn = false;
                    updatePromptButtonState();
                    // í”„ë¡¬í”„íŠ¸ëŠ” ìœ ì§€
                }
            }
            img.onerror = () => {
                console.error(`Failed to load template image: ${template.url}`);
                if (!isSilent) showMessage('ë°‘ê·¸ë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
            img.src = template.url;
        }

        /**
         * Restores the canvas to the previous state from the history stack.
         */
        function undoAction() {
            if (historyStack.length > 1) {
                // 1. í˜„ì¬ ìƒíƒœ (ë˜ëŒë¦´ ìƒíƒœ)ë¥¼ ìŠ¤íƒì—ì„œ ì œê±°
                historyStack.pop(); 
                
                // 2. ì§ì „ ìƒíƒœì˜ Data URL ê°€ì ¸ì˜¤ê¸°
                const prevStateDataURL = historyStack[historyStack.length - 1]; 

                const img = new Image();
                img.onload = function() {
                    const canvasDisplayWidth = canvas.width / RESOLUTION_SCALE;
                    const canvasDisplayHeight = canvas.height / RESOLUTION_SCALE;

                    // 3. ìº”ë²„ìŠ¤ë¥¼ ê¹¨ë—í•˜ê²Œ ì§€ìš°ê³ 
                    ctx.clearRect(0, 0, canvasDisplayWidth, canvasDisplayHeight);
                    
                    // 4. ì´ì „ ìƒíƒœ ì´ë¯¸ì§€ë¡œ ë³µì›
                    ctx.drawImage(img, 0, 0, canvasDisplayWidth, canvasDisplayHeight);
                    
                    updateUndoButtonState();
                    showMessage('ë˜ëŒë¦¬ê¸° ì™„ë£Œ');
                    
                    // íˆìŠ¤í† ë¦¬ê°€ 1ê°œ ì´ˆê³¼ì´ë©´ ì‚¬ìš©ìê°€ ê·¸ë¦° ë‚´ìš©ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ê°„ì£¼ (í…œí”Œë¦¿ ìƒíƒœë§Œ ìˆì„ ê²½ìš° 1)
                    hasDrawn = historyStack.length > 1; 
                    updatePromptButtonState();
                    // ë˜ëŒë¦¬ê¸° ì‹œ í”„ë¡¬í”„íŠ¸ ê²°ê³¼ ìˆ¨ê¹€ (í”„ë¡¬í”„íŠ¸ëŠ” ìœ ì§€)
                    promptOutput.classList.add('hidden'); 
                };
                img.src = prevStateDataURL;
            } else {
                showMessage('ë” ì´ìƒ ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }


        /**
         * Dynamically generates the template thumbnails in the left panel.
         */
        function setupTemplates() {
            templateSelector.innerHTML = ''; // Clear existing
            templates.forEach((template, index) => {
                const img = document.createElement('img');
                img.className = 'template-thumbnail rounded-lg border-2 border-gray-300';
                img.src = template.url;
                img.alt = template.title;
                img.title = `${template.title} ì„ íƒ`;
                img.dataset.index = index;
                
                if (index === activeTemplateIndex) {
                    img.classList.add('active', 'border-indigo-600');
                    img.classList.remove('border-gray-300');
                }

                templateSelector.appendChild(img);
            });
        }


        /**
         * Sets drawing parameters based on the current tool.
         */
        function setDrawingStyle() {
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = lineWidth;

            if (currentTool === 'eraser') {
                ctx.strokeStyle = '#FFFFFF'; // White color for erasing background
            } else {
                ctx.strokeStyle = color;
            }
        }

        // --- Event Handlers (Drawing and UI) ---

        function startDrawing(e) {
            if (currentTool === 'text') return; 

            isDrawing = true;
            // ê·¸ë¦¼ì´ ì‹œì‘ë˜ì—ˆìŒì„ í‘œì‹œ
            hasDrawn = true; 
            updatePromptButtonState();
            promptOutput.classList.add('hidden'); // ë“œë¡œì‰ ì‹œì‘í•˜ë©´ í”„ë¡¬í”„íŠ¸ ê²°ê³¼ ìˆ¨ê¸°ê¸°

            [lastX, lastY] = getCanvasCoordinates(e);
            setDrawingStyle();
            
            // Draw initial dot for clicks/taps
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(lastX, lastY);
            ctx.stroke();

            draw(e); 
        }

        function draw(e) {
            if (!isDrawing || currentTool === 'text') return;
            e.preventDefault(); 
            const [x, y] = getCanvasCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        }

        function stopDrawing() {
            if (isDrawing) {
                 isDrawing = false;
                 // --- HISTORY: Save the state after a drawing stroke ends ---
                 saveState();
            }
        }

        function getCanvasCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) {
                x = (e.touches[0].clientX - rect.left) / RESOLUTION_SCALE;
                y = (e.touches[0].clientY - rect.top) / RESOLUTION_SCALE;
            } else {
                x = (e.clientX - rect.left) / RESOLUTION_SCALE;
                y = (e.clientY - rect.top) / RESOLUTION_SCALE;
            }
            return [x, y];
        }

        /**
         * í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œë¥¼ í˜„ì¬ íˆ´ ì„¤ì •ì— ë§ì¶° ì¤€ë¹„í•˜ê³  í‘œì‹œí•©ë‹ˆë‹¤.
         */
        function handleTextToolClick(e) {
            if (currentTool !== 'text') return;

            const [x, y] = getCanvasCoordinates(e); // ìº”ë²„ìŠ¤ ì¢Œí‘œ (CSS í”½ì…€)
            const containerRect = container.getBoundingClientRect();

            // ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œì˜ ìƒëŒ€ì ì¸ ìœ„ì¹˜ (DOM ìš”ì†Œ ìœ„ì¹˜)
            const offsetX = e.clientX - containerRect.left;
            const offsetY = e.clientY - containerRect.top;

            textInput.style.left = `${offsetX}px`;
            textInput.style.top = `${offsetY}px`;
            
            // í…ìŠ¤íŠ¸ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì ìš©
            textInput.style.color = color;
            textInput.style.fontSize = `${lineWidth * 2}px`; // êµµê¸°ì— ë”°ë¼ í°íŠ¸ í¬ê¸° ì¡°ì •
            textInput.style.fontWeight = 'bold'; // ìº”ë²„ìŠ¤ ë“œë¡œì‰ê³¼ ì¼ê´€ì„±ì„ ìœ„í•´ êµµê²Œ
            
            textInput.value = '';
            textInput.classList.remove('hidden');
            textInput.focus();
            
            // ìº”ë²„ìŠ¤ ì¢Œí‘œ (CSS í”½ì…€) ì €ì¥
            textInput.dataset.canvasX = x;
            textInput.dataset.canvasY = y;
        }

        // í…ìŠ¤íŠ¸ ì…ë ¥ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥ ì¶”ê°€
        textInput.addEventListener('input', () => {
             // í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•  ë•Œë§ˆë‹¤ ì…ë ¥ í•„ë“œì˜ ë„ˆë¹„ë¥¼ ë‚´ìš©ì— ë§ê²Œ ì¡°ì •
             textInput.style.width = `${textInput.scrollWidth + 10}px`;
        });

        // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì—ì„œ í¬ì»¤ìŠ¤ë¥¼ ìƒì—ˆì„ ë•Œ (í…ìŠ¤íŠ¸ ì…ë ¥ ì™„ë£Œ)
        textInput.addEventListener('blur', () => {
            const text = textInput.value.trim();
            textInput.classList.add('hidden'); // í•„ë“œë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
            
            if (text) {
                const x = parseFloat(textInput.dataset.canvasX); // ìº”ë²„ìŠ¤ X (CSS í”½ì…€)
                const y = parseFloat(textInput.dataset.canvasY); // ìº”ë²„ìŠ¤ Y (CSS í”½ì…€)

                // í…ìŠ¤íŠ¸ ë Œë”ë§ ì„¤ì • (ë¯¸ë¦¬ë³´ê¸° CSS ìŠ¤íƒ€ì¼ê³¼ ì¼ê´€ë˜ê²Œ)
                // í°íŠ¸ í¬ê¸°ëŠ” lineWidth * 2ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
                ctx.font = `bold ${lineWidth * 2}px Inter, sans-serif`; 
                ctx.fillStyle = color;
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                
                // í…ìŠ¤íŠ¸ë¥¼ ê·¸ë¦½ë‹ˆë‹¤.
                ctx.fillText(text, x, y);
                
                // í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í–ˆìœ¼ë¯€ë¡œ hasDrawnì„ trueë¡œ ì„¤ì •
                hasDrawn = true;
                updatePromptButtonState();
                promptOutput.classList.add('hidden'); // í…ìŠ¤íŠ¸ ì…ë ¥ ì‹œ í”„ë¡¬í”„íŠ¸ ê²°ê³¼ ìˆ¨ê¸°ê¸°
                
                // --- HISTORY: Save the state after text is drawn ---
                saveState();
            }
            textInput.value = ''; // ê°’ ì´ˆê¸°í™”
        });
        
        // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œì—ì„œ ì—”í„°ë¥¼ ëˆŒë €ì„ ë•Œ (blur íŠ¸ë¦¬ê±°)
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // ê¸°ë³¸ Enter ë™ì‘(ì¤„ ë°”ê¿ˆ) ë°©ì§€
                textInput.blur(); // blur ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°
            }
        });

        // í…ìŠ¤íŠ¸ ì…ë ¥ ëª¨ë“œì—ì„œëŠ” ìº”ë²„ìŠ¤ í´ë¦­ ì‹œ í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œë¥¼ í‘œì‹œ
        canvas.addEventListener('click', (e) => {
            if (currentTool === 'text') {
                handleTextToolClick(e);
            }
        });


        // --- UI Event Listeners ---

        // Initialize templates and canvas on load
        window.addEventListener('load', () => {
            setupTemplates(); 
            resizeCanvas(); 
        });

        // Handle resize events
        window.addEventListener('resize', resizeCanvas); 

        // Line width change
        lineWidthInput.addEventListener('input', (e) => {
            lineWidth = parseInt(e.target.value);
            lineWidthValue.textContent = lineWidth;
            setDrawingStyle(); 
            // í…ìŠ¤íŠ¸ í•„ë“œê°€ ë³´ì¼ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            if (!textInput.classList.contains('hidden')) {
                textInput.style.fontSize = `${lineWidth * 2}px`; 
            }
        });

        // Color selection
        colorPalette.addEventListener('click', (e) => {
            if (e.target.dataset.color) {
                color = e.target.dataset.color;
                setDrawingStyle();
                // ìƒ‰ìƒ ì„ íƒ í›„ ìë™ìœ¼ë¡œ ë¶“ ë„êµ¬ë¡œ ì „í™˜
                document.getElementById('toolBrush').click(); 
                 // í…ìŠ¤íŠ¸ í•„ë“œê°€ ë³´ì¼ ê²½ìš° ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                if (!textInput.classList.contains('hidden')) {
                    textInput.style.color = color;
                }
            }
        });

        // Tool selection
        toolButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentTool = button.dataset.tool;
                setDrawingStyle();
                
                toolButtons.forEach(btn => {
                    btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-xl');
                    btn.classList.add('bg-white', 'text-gray-700', 'border-gray-300');
                });
                button.classList.remove('bg-white', 'text-gray-700', 'border-gray-300');
                button.classList.add('bg-indigo-600', 'text-white', 'shadow-xl');

                // í…ìŠ¤íŠ¸ ë„êµ¬ê°€ ì•„ë‹Œ ê²½ìš° ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸°
                if (currentTool !== 'text') {
                    textInput.classList.add('hidden');
                    descriptionText.textContent = 'ë°‘ê·¸ë¦¼ì„ ì„ íƒí•˜ê³ , ìƒ‰ê³¼ êµµê¸°ë¥¼ ì •í•œ í›„ ììœ ë¡­ê²Œ ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”! (í…ìŠ¤íŠ¸ ë„êµ¬ ì„ íƒ í›„ ìº”ë²„ìŠ¤ í´ë¦­)';
                } else {
                    descriptionText.textContent = 'í…ìŠ¤íŠ¸ ë„êµ¬ë¥¼ ì„ íƒí–ˆìŠµë‹ˆë‹¤. ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•˜ì—¬ í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”!';
                }
            });
        });

        // Template selection
        templateSelector.addEventListener('click', (e) => {
            const target = e.target.closest('.template-thumbnail');
            if (target) {
                const index = parseInt(target.dataset.index);
                loadTemplate(index);
            }
        });

        // Clear button
        clearButton.addEventListener('click', () => {
            loadTemplate(activeTemplateIndex); 
            showMessage('ìº”ë²„ìŠ¤ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            hasDrawn = false;
            updatePromptButtonState();
            promptOutput.classList.add('hidden'); // ì´ˆê¸°í™” ì‹œ í”„ë¡¬í”„íŠ¸ ê²°ê³¼ ìˆ¨ê¸°ê¸°
            descriptionText.textContent = 'ë°‘ê·¸ë¦¼ì„ ì„ íƒí•˜ê³ , ìƒ‰ê³¼ êµµê¸°ë¥¼ ì •í•œ í›„ ììœ ë¡­ê²Œ ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”! (í…ìŠ¤íŠ¸ ë„êµ¬ ì„ íƒ í›„ ìº”ë²„ìŠ¤ í´ë¦­)';
            currentInputPrompt = ''; // ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” (íŒŒì¼ëª…ì— ì‚¬ìš©ë  ìˆ˜ ìˆê¸° ë•Œë¬¸)
            promptInput.value = ''; // ì…ë ¥ í”„ë¡¬í”„íŠ¸ í•„ë“œ ì´ˆê¸°í™”
        });
        
        // Undo button
        undoButton.addEventListener('click', undoAction);

        // --- í”„ë¡¬í”„íŠ¸ ë“±ë¡ ë¡œì§ êµ¬í˜„ ---
        promptInput.addEventListener('input', updatePromptButtonState);
        registerPromptButton.addEventListener('click', () => {
            const prompt = promptInput.value.trim();
            if (prompt.length > 0) {
                currentInputPrompt = prompt; // í”„ë¡¬í”„íŠ¸ ë“±ë¡
                promptTextDisplay.textContent = prompt;
                promptOutput.classList.remove('hidden');
                descriptionText.textContent = 'í”„ë¡¬í”„íŠ¸ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê·¸ë¦¼ì„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                showMessage('âœ… í”„ë¡¬í”„íŠ¸ ë“±ë¡ ì™„ë£Œ!');
            } else if (hasDrawn) {
                // ê·¸ë¦¼ì€ ê·¸ë ¸ëŠ”ë° í…ìŠ¤íŠ¸ê°€ ì—†ìœ¼ë©´, ê·¸ë¦¼ì´ ì°¸ê³  ì´ë¯¸ì§€ë¡œ ì‚¬ìš©ë¨ì„ ëª…ì‹œ
                currentInputPrompt = 'ì‚¬ìš©ìê°€ ì§ì ‘ ê·¸ë¦° ìŠ¤ì¼€ì¹˜ì…ë‹ˆë‹¤.';
                promptTextDisplay.textContent = currentInputPrompt;
                promptOutput.classList.remove('hidden');
                descriptionText.textContent = 'í”„ë¡¬í”„íŠ¸ ì—†ì´ ê·¸ë¦¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ê·¸ë¦¼ì„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                showMessage('âœ… í”„ë¡¬í”„íŠ¸ ë“±ë¡ ì™„ë£Œ (ê·¸ë¦¼ë§Œ)!');
            } else {
                showMessage('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ ê·¸ë¦¼ì„ ê·¸ë ¤ì•¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
            }
        });

        // í”„ë¡¬í”„íŠ¸ ë³µì‚¬ ë²„íŠ¼
        copyPromptButton.addEventListener('click', () => {
            if (currentInputPrompt) {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(currentInputPrompt)
                        .then(() => showMessage('ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'))
                        .catch(err => fallbackCopyTextToClipboard(currentInputPrompt));
                } else {
                    fallbackCopyTextToClipboard(currentInputPrompt);
                }
            } else {
                 showMessage('ë“±ë¡ëœ í”„ë¡¬í”„íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
        });


        // --- ê·¸ë¦¼ ì €ì¥ ë¡œì§ êµ¬í˜„ ---
        saveButton.addEventListener('click', () => {
            // í”„ë¡¬í”„íŠ¸ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì„ì‹œ í”„ë¡¬í”„íŠ¸ ì‚¬ìš©
            let finalPrompt = currentInputPrompt || (hasDrawn ? 'ì‚¬ìš©ìê°€ ì§ì ‘ ê·¸ë¦° ìŠ¤ì¼€ì¹˜ì…ë‹ˆë‹¤.' : 'ë¹ˆ ìº”ë²„ìŠ¤');
            
            // íŒŒì¼ëª…ì— ì‚¬ìš©í•  ì§§ì€ ë²„ì „ì˜ í”„ë¡¬í”„íŠ¸ (íŠ¹ìˆ˜ë¬¸ì ì œê±° ë° 20ì ì œí•œ)
            const safeFileName = finalPrompt.replace(/[^a-z0-9ã„±-ã…ê°€-í£\s]/gi, '').substring(0, 20).trim() || 'my_sketch';
            const fileName = `sketch_with_${safeFileName.replace(/\s/g, '_')}_${Date.now()}.png`;

            // Data URL ê°€ì ¸ì˜¤ê¸°
            const imageURL = canvas.toDataURL('image/png'); 
            
            // ë‹¤ìš´ë¡œë“œ ë§í¬ ìƒì„± ë° í´ë¦­
            const a = document.createElement('a');
            a.href = imageURL;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);

            showMessage('ê·¸ë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });


        // --- Canvas Event Listeners (Mouse/Touch) ---
        
        // Mouse Events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Touch Events
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);
    </script>
</body>
</html>